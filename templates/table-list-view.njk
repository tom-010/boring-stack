{#
  Template: List Page with Pagination, Search, and Sortable Columns

  Available fields:
    - filename: Route filename without extension (e.g., "users-list")
    - entityName: Singular name, PascalCase (e.g., "User")
    - entityNamePlural: Plural name, PascalCase (e.g., "Users")
    - entityLabel: Singular display name, lowercase (e.g., "user")
    - entityLabelPlural: Plural display name, lowercase (e.g., "users")
    - basePath: URL base path (e.g., "/users")
    - prismaModel: Prisma model name (e.g., "user")
    - icon: Lucide icon name for empty state (e.g., "Users")
    - sortFields: Array of sortable field configs
        - name: Field name in DB (e.g., "name", "createdAt")
        - label: Display label (e.g., "Name", "Created")
        - type: "string" | "date" | "number"
    - columns: Array of table column configs
        - field: Field name (e.g., "name", "email")
        - label: Header label (e.g., "Name", "Email")
        - sortable: boolean
        - link: boolean (makes it a link to detail page)
        - hiddenOnMobile: boolean
        - type: "string" | "date" | "number"
    - searchFields: Array of field names to search (e.g., ["name", "email"])
    - ownerField: Field name for ownership check (e.g., "ownerId"), or null if no ownership

  Example usage:
    {
      "filename": "users-list",
      "entityName": "User",
      "entityNamePlural": "Users",
      "entityLabel": "user",
      "entityLabelPlural": "users",
      "basePath": "/admin/users",
      "prismaModel": "user",
      "icon": "Users",
      "sortFields": [
        { "name": "name", "label": "Name", "type": "string" },
        { "name": "email", "label": "Email", "type": "string" },
        { "name": "createdAt", "label": "Created", "type": "date" }
      ],
      "columns": [
        { "field": "name", "label": "Name", "sortable": true, "link": true },
        { "field": "email", "label": "Email", "sortable": true, "hiddenOnMobile": true },
        { "field": "createdAt", "label": "Created", "sortable": true, "hiddenOnMobile": true, "type": "date" }
      ],
      "searchFields": ["name", "email"],
      "ownerField": null
    }
#}
import type { Route } from "./+types/{{ filename }}";
import type { RouteHandle } from "~/components/page-header";
import { Link, redirect, useSearchParams, useFetcher } from "react-router";
import { Plus, {{ icon }}, Pencil, Trash2, MoreHorizontal, ArrowUp, ArrowDown } from "lucide-react";
import { Button } from "~/components/ui/button";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "~/components/ui/table";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "~/components/ui/dropdown-menu";
import { ConfirmDialog } from "~/components/confirm-dialog";
import { ListPagination } from "~/components/list-pagination";
import { SearchBar } from "~/components/search-bar";
import { db } from "~/db/client";
import { auth } from "~/lib/auth.server";
import { parseFormDataOrThrow } from "~/lib/forms";
import { deleteByIdSchema } from "~/lib/schemas";
import { log } from "~/lib/logger.server";

export const handle: RouteHandle = {
  breadcrumb: { label: "{{ entityNamePlural }}", href: "{{ basePath }}" },
};

const PAGE_SIZE = 30;
const BASE_PATH = "{{ basePath }}";

type SortField = {{ sortFields | map(attribute='name') | map('dump') | join(' | ') }};
type SortOrder = "asc" | "desc";

export async function loader({ request }: Route.LoaderArgs) {
  const session = await auth.api.getSession({ headers: request.headers });
  const userId = session!.user.id;

  const url = new URL(request.url);
  const query = url.searchParams.get("q")?.trim();
  const page = Math.max(1, parseInt(url.searchParams.get("page") || "1", 10));
  const sortParam = url.searchParams.get("sort");
  const orderParam = url.searchParams.get("order");

  const validSorts = [{{ sortFields | map(attribute='name') | map('dump') | join(', ') }}];
  const sort: SortField | null = validSorts.includes(sortParam || "")
    ? (sortParam as SortField)
    : null;
  const order: SortOrder = orderParam === "asc" ? "asc" : "desc";

  const searchCondition = query
    ? {
        OR: [
{% for field in searchFields %}
          { {{ field }}: { contains: query, mode: "insensitive" as const } },
{% endfor %}
        ],
      }
    : {};

  const where = {
{% if ownerField %}
    {{ ownerField }}: userId,
{% endif %}
    ...searchCondition,
  };

  const orderBy = sort === null
    ? { createdAt: "desc" as const }
    : { [sort]: order };

  const [total, items] = await Promise.all([
    db.{{ prismaModel }}.count({ where }),
    db.{{ prismaModel }}.findMany({
      where,
      orderBy,
      skip: (page - 1) * PAGE_SIZE,
      take: PAGE_SIZE,
    }),
  ]);

  const totalPages = Math.ceil(total / PAGE_SIZE);

  return {
    items,
    currentUserId: userId,
    pagination: { page, pageSize: PAGE_SIZE, total, totalPages },
    sort,
    order,
  };
}

export async function action({ request }: Route.ActionArgs) {
  const session = await auth.api.getSession({ headers: request.headers });
  const userId = session!.user.id;

  const formData = await request.formData();
  const { id } = parseFormDataOrThrow(formData, deleteByIdSchema);

{% if ownerField %}
  await db.{{ prismaModel }}.delete({ where: { id, {{ ownerField }}: userId } });
{% else %}
  await db.{{ prismaModel }}.delete({ where: { id } });
{% endif %}
  log.info({ {{ entityLabel }}Id: id }, "{{ entityLabel }}_deleted");

  return redirect("{{ basePath }}");
}

export function meta() {
  return [
    { title: "{{ entityNamePlural }}" },
    { name: "description", content: "Manage your {{ entityLabelPlural }}" },
  ];
}

function Delete{{ entityName }}Button({ itemId, itemName }: { itemId: string; itemName: string }) {
  const fetcher = useFetcher();

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="sm">
          <MoreHorizontal className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <ConfirmDialog
          title={`Delete "${itemName}"?`}
          description="This action cannot be undone."
          confirmLabel="Delete"
          variant="destructive"
          onConfirm={() => {
            fetcher.submit(
              { intent: "delete", id: itemId },
              { method: "post" }
            );
          }}
        >
          <DropdownMenuItem onSelect={(e) => e.preventDefault()}>
            <Trash2 className="h-4 w-4 mr-2" />
            Delete
          </DropdownMenuItem>
        </ConfirmDialog>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

function buildPageUrl(page: number, searchParams: URLSearchParams) {
  const params = new URLSearchParams(searchParams);
  if (page === 1) {
    params.delete("page");
  } else {
    params.set("page", String(page));
  }
  const qs = params.toString();
  return qs ? `?${qs}` : BASE_PATH;
}

function SortableHeader({
  field,
  currentSort,
  currentOrder,
  searchParams,
  children,
  className,
}: {
  field: SortField;
  currentSort: SortField | null;
  currentOrder: SortOrder;
  searchParams: URLSearchParams;
  children: React.ReactNode;
  className?: string;
}) {
  const isActive = currentSort === field;
  let nextOrder: SortOrder | null;
  if (!isActive) {
    nextOrder = "asc";
  } else if (currentOrder === "asc") {
    nextOrder = "desc";
  } else {
    nextOrder = null;
  }

  const params = new URLSearchParams(searchParams);
  params.delete("page");
  if (nextOrder === null) {
    params.delete("sort");
    params.delete("order");
  } else {
    params.set("sort", field);
    params.set("order", nextOrder);
  }
  const href = params.toString() ? `?${params.toString()}` : BASE_PATH;

  return (
    <Link to={href} className={`flex items-center gap-1 hover:text-foreground ${className || ""}`}>
      {children}
      {isActive && (
        currentOrder === "asc" ? (
          <ArrowUp className="h-4 w-4" />
        ) : (
          <ArrowDown className="h-4 w-4" />
        )
      )}
    </Link>
  );
}

export default function {{ entityNamePlural }}ListPage({ loaderData }: Route.ComponentProps) {
  const [searchParams] = useSearchParams();
  const query = searchParams.get("q") || "";
  const { items, currentUserId, pagination, sort, order } = loaderData;
  const { page, total, totalPages, pageSize } = pagination;
  const startIndex = (page - 1) * pageSize;

  return (
    <div className="p-6 md:p-8">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">{{ entityNamePlural }}</h1>
          <p className="text-muted-foreground">Manage your {{ entityLabelPlural }}</p>
        </div>

        <div className="flex gap-2 mb-6">
          <SearchBar placeholder="Search {{ entityLabelPlural }}..." defaultValue={query} />
          <Button asChild>
            <Link to="{{ basePath }}/new">
              <Plus className="h-4 w-4 mr-2" />
              New {{ entityLabel | capitalize }}
            </Link>
          </Button>
        </div>

        {items.length === 0 && total === 0 ? (
          <div className="text-center text-muted-foreground py-12">
            <{{ icon }} className="h-12 w-12 mx-auto mb-4 opacity-50" />
            <p className="text-lg">
              {query ? "No {{ entityLabelPlural }} match your search." : "No {{ entityLabelPlural }} yet. Create one to get started!"}
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="rounded-lg border">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-12">#</TableHead>
{% for col in columns %}
{% if col.sortable %}
                    <TableHead{% if col.hiddenOnMobile %} className="hidden md:table-cell"{% endif %}>
                      <SortableHeader field="{{ col.field }}" currentSort={sort} currentOrder={order} searchParams={searchParams}>
                        {{ col.label }}
                      </SortableHeader>
                    </TableHead>
{% else %}
                    <TableHead{% if col.hiddenOnMobile %} className="hidden md:table-cell"{% endif %}>{{ col.label }}</TableHead>
{% endif %}
{% endfor %}
                    <TableHead></TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {items.map((item, idx) => {
{% if ownerField %}
                    const isOwner = item.{{ ownerField }} === currentUserId;
{% endif %}
                    return (
                      <TableRow key={item.id}>
                        <TableCell className="font-medium text-muted-foreground">
                          {startIndex + idx + 1}
                        </TableCell>
{% for col in columns %}
{% if col.link %}
                        <TableCell{% if col.hiddenOnMobile %} className="hidden md:table-cell"{% endif %}>
                          <Link
                            to={`{{ basePath }}/${item.id}`}
                            className="hover:underline font-medium"
                          >
                            {item.{{ col.field }}}
                          </Link>
                        </TableCell>
{% elif col.type == 'date' %}
                        <TableCell className="{% if col.hiddenOnMobile %}hidden md:table-cell {% endif %}text-sm text-muted-foreground">
                          {new Date(item.{{ col.field }}).toLocaleDateString()}
                        </TableCell>
{% else %}
                        <TableCell className="{% if col.hiddenOnMobile %}hidden md:table-cell {% endif %}text-sm text-muted-foreground">
                          {item.{{ col.field }} || "-"}
                        </TableCell>
{% endif %}
{% endfor %}
                        <TableCell className="text-right">
                          <div className="flex items-center justify-end gap-1">
                            <Button variant="ghost" size="sm" asChild>
                              <Link to={`{{ basePath }}/${item.id}`}>
                                <Pencil className="h-4 w-4" />
                              </Link>
                            </Button>
{% if ownerField %}
                            {isOwner && (
                              <Delete{{ entityName }}Button itemId={item.id} itemName={item.{{ columns[0].field }}} />
                            )}
{% else %}
                            <Delete{{ entityName }}Button itemId={item.id} itemName={item.{{ columns[0].field }}} />
{% endif %}
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </div>

            <ListPagination
              page={page}
              totalPages={totalPages}
              buildPageUrl={(p) => buildPageUrl(p, searchParams)}
            />

            <div className="text-sm text-muted-foreground text-center">
              Showing {startIndex + 1} to {Math.min(startIndex + pageSize, total)} of {total} {{ entityLabelPlural }}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
